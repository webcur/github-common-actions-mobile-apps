name: push-ipa-to-test-flight

on:
  workflow_dispatch:
    inputs:
      runner:
        description: Runner. e.g. self-hosted
        required: false
        default: macos-latest
        type: string
      environment:
        description: Environment. e.g. stage
        required: false
        type: environment
      ipa-artifact-name:
        description: IPA artifact name. e.g. ios.ipa
        required: true
        default: ios.ipa
        type: string
      fastlane-lane:
        description: Fastlane lane
        type: string
      fastlane-args:
        description: Fastlane args. e.g. flavor:stage
        type: string
      app-name:
        description: App Name
        type: string
        default: App Name
        required: true
      final-ipa-file-name:
        description: Final IPA file name.
        type: string
        required: true
      bundle-id:
        description: App Bundle ID
        type: string
        required: false
  workflow_call:
    inputs:
      runner:
        description: Runner. e.g. self-hosted
        default: macos-latest
        required: false
        type: string
      environment:
        description: Environment. e.g. stage
        required: false
        type: string
      ipa-artifact-name:
        description: IPA artifact name. e.g. ios.ipa
        required: false
        default: ios.ipa
        type: string
      app-name:
        description: App Name
        type: string
        default: App Name
        required: true
      fastlane-lane:
        description: Fastlane lane
        type: string
      fastlane-args:
        description: Fastlane args. e.g. flavor:stage
        type: string
        required: false
      final-ipa-file-name:
        description: Final IPA file name.
        type: string
        required: true
      bundle-id:
        description: App Bundle ID
        type: string
        required: false
    secrets:
      APPSTORE_CONNECT_JSON_BASE64:
        description: Fastlane app store connect credential json
        required: true
      GITHUB_ENV_TOKEN:
        description: Github token to download release
        required: true

jobs:
  push-ipa-to-test-flight:
    name: Push IPA to TestFlight
    runs-on: ${{ inputs.runner }}
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.ipa-artifact-name }}

      - name: Move IPA Artifact
        run: |
          mv ${{ inputs.app-name }}.ipa ${{ inputs.final-ipa-file-name }}.ipa

      - name: Prepare App Store Connect Credential
        run: |
          echo "${{ secrets.APPSTORE_CONNECT_JSON_BASE64 }}" | base64 --decode > ios/fastlane/api.json

      - name: Set BUNDLE_ID environmental variable
        if: ${{ inputs.bundle-id != '' }}
        run: echo "BUNDLE_ID=${{ inputs.bundle-id }}" >> $GITHUB_ENV

      - name: Upload IPA to TestFlight
        run: |
          cd ios && fastlane ${{ inputs.fastlane-lane }} ${{ inputs.fastlane-args }}

      - name: Clean Up App Store Connect Credentials
        if: ${{ always() }}
        run: rm -f ios/fastlane/api.json

      - if: ${{ failure() }}
        name: The job has failed
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_MESSAGE: 'Push IPA :ios: to Test Flight for `${{ github.event.repository.name }}` failed :x:.'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
