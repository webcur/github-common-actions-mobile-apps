name: push-ipa-to-test-flight

on:
  workflow_call:
    inputs:
      runner:
        description: Runner. e.g. self-hosted
        default: macos-latest
        required: false
        type: string
      environment:
        description: Environment. e.g. stage
        required: false
        type: string
      ipa-artifact-name:
        description: IPA artifact name. e.g. ios.ipa
        required: false
        default: ios.ipa
        type: string
      app-name:
        description: App Name
        type: string
        default: App Name
        required: true
      fastlane-lane:
        description: Fastlane lane
        type: string
      fastlane-args:
        description: Fastlane args. e.g. flavor:stage
        type: string
        required: false
      final-ipa-file-name:
        description: Final IPA file name.
        type: string
        required: true
      bundle-id:
        description: App Bundle ID
        type: string
        required: false
    secrets:
      APPSTORE_CONNECT_JSON_BASE64:
        description: Fastlane app store connect credential json
        required: true
      GITHUB_ENV_TOKEN:
        description: Github token to download release
        required: true

jobs:
  push-ipa-to-test-flight:
    name: Push IPA to TestFlight
    runs-on: ${{ inputs.runner }}
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.ipa-artifact-name }}

      - name: LS IPA File
        run: ls -la

      - name: Move IPA Artifact
        run: |
          mv "${{ inputs.app-name }}.ipa" "${{ inputs.final-ipa-file-name }}.ipa"

      - name: Prepare App Store Connect Credential
        run: |
          echo "${{ secrets.APPSTORE_CONNECT_JSON_BASE64 }}" | base64 --decode > ios/fastlane/api.json

      - name: Set BUNDLE_ID environmental variable
        if: ${{ inputs.bundle-id != '' }}
        run: echo "BUNDLE_ID=${{ inputs.bundle-id }}" >> $GITHUB_ENV

      - name: Upload IPA to TestFlight
        timeout-minutes: 15
        id: push-to-test-flight
        continue-on-error: true
        run: |
          set +e
          (cd ios && fastlane ${{ inputs.fastlane-lane }} ${{ inputs.fastlane-args }}) & 
          pid=$!
          
          # Wait up to 840 seconds (14 minutes) - slightly less than GitHub timeout
          for i in {1..840}; do
            if ! kill -0 $pid 2>/dev/null; then
              wait $pid
              exit_code=$?
              if [ $exit_code -eq 0 ]; then
                echo "PUSH_STATUS=success" >> $GITHUB_ENV
              else
                echo "PUSH_STATUS=failed" >> $GITHUB_ENV
              fi
              exit 0
            fi
            sleep 1
          done
          
          # If we got here, it's a timeout - treat as success
          echo "PUSH_STATUS=timeout" >> $GITHUB_ENV
          kill $pid 2>/dev/null
          exit 0

      - if: ${{ env.PUSH_STATUS == 'failed' }}
        name: Fail job
        run: |
          echo "Uploading IPA to TestFlight failed."
          exit 1

      - name: Clean Up App Store Connect Credentials
        if: ${{ always() }}
        run: rm -f ios/fastlane/api.json

      - if: ${{ failure() }}
        name: The job has failed
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_MESSAGE: 'Push IPA :ios: to Test Flight for `${{ github.event.repository.name }}` failed :x:.'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
